<!-- 
This page provides students with an overview of their financial status,
including total fees, amount paid, and current balance. It also presents
options for making payments, although the payment buttons are placeholders.
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta tags for character set and compatibility -->
  <meta charset="UTF-8">
  
  <!-- Page title -->
  <title>Payments</title>
  
  <!-- Link to the main dashboard stylesheet -->
  <link rel="stylesheet" href="dashboard.css">
  
  <!-- Internal styles for this page -->
    <style>
        /* Style for informational messages (e.g., loading, error) */
        .info-message {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-left: 4px solid #002366; /* Cavendish Blue accent */
            color: #333;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
  <!-- Sidebar navigation menu -->
  <div class="sidebar">
    <a href="dashboard.html">Home</a>
    <a href="dockets.html">Dockets</a>
    <a href="payments.html" class="active">Payments</a>
    <a href="results.html">Results</a>
  </div>

  <!-- Header section with logo, title, and logout button -->
  <div class="header">
    <img src="cavendish-logo.png" alt="Cavendish Logo" class="logo">
    <h1>Payments</h1>
    <button class="logout" id="logoutBtn">Logout</button>
  </div>

  <!-- Main content area -->
  <div class="main">
    <h2>Your Financial Overview</h2>
    <p>Review your fee summary below and proceed to make a payment.</p>
    
    <!-- This section will be dynamically filled with the student's financial data -->
    <div id="financial-section">
        <div class="info-message">Loading financial data...</div>
    </div>

    <!-- Placeholder section for payment options -->
    <div class="payment-options">
        <h2>Make a Payment</h2>
        <p>Select a payment method to settle your balance.</p>
        <div class="payment-gateways">
            <!-- These buttons are currently placeholders and do not have functionality -->
            <button class="gateway-btn">MTN Mobile Money</button>
            <button class="gateway-btn">Airtel Mobile Money</button>
            <button class="gateway-btn">Visa / Mastercard</button>
        </div>
    </div>
  </div>

<!-- JavaScript for fetching and displaying financial data -->
<script>
/**
 * Formats a number into a Zambian Kwacha currency string (e.g., K 1,234.56).
 * @param {number|string} amount - The numerical amount to format.
 * @returns {string} The formatted currency string.
 */
function formatKwacha(amount) {
    return `K ${parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
}

/**
 * Asynchronously fetches the student's financial data from the server
 * and displays it in the financial overview section.
 */
async function loadFinancials() {
    const student_id = localStorage.getItem("student_id");
    const student_number = localStorage.getItem("student_number");
    const financialSection = document.getElementById("financial-section");

    // Use student number if available, otherwise fall back to student ID
    const query = student_number || student_id;
    if (!query) {
        financialSection.innerHTML = `<div class="info-message">Could not identify student. Please log in again.</div>`;
        return;
    }

    // A generic message for when financial data cannot be displayed
    const unavailableMessage = `
        <div class="info-message">
            <p><strong>Financial Data Unavailable</strong></p>
            <p>Your financial overview cannot be displayed at this time. Please check back later or contact the administration office for assistance.</p>
        </div>`;

    try {
        // Fetch student data using the search endpoint
        const res = await fetch(`/dockets/students/search?q=${query}`);

        // If the server responds with a 403 Forbidden, it means access to financials is restricted
        if (res.status === 403) {
            financialSection.innerHTML = unavailableMessage;
            return;
        }

        const json = await res.json();

        // If the request failed or no student was found, show the unavailable message
        if (!json.ok || !json.students || json.students.length === 0) {
            financialSection.innerHTML = unavailableMessage;
            return;
        }

        // Display the financial summary using data from the first student record found
        const student = json.students[0];
        const summaryHtml = `
            <div class="financial-summary">
                <div class="summary-card total-fee">
                    <h3>Total Program Fee</h3>
                    <p class="amount">${formatKwacha(student.total_fee)}</p>
                </div>
                <div class="summary-card amount-paid">
                    <h3>Total Amount Paid</h3>
                    <p class="amount">${formatKwacha(student.amount_paid)}</p>
                </div>
                <div class="summary-card balance">
                    <h3>Current Balance</h3>
                    <p class="amount">${formatKwacha(student.balance)}</p>
                </div>
            </div>
        `;
        financialSection.innerHTML = summaryHtml;

    } catch (error) {
        console.error('Error fetching financials:', error);
        financialSection.innerHTML = unavailableMessage;
    }
}

/**
 * Handles the logout process by clearing local storage and redirecting to the login page.
 */
document.getElementById("logoutBtn").onclick = async () => {
    localStorage.clear();
    window.location.href = "students-portal.html";
};

// Initial load of financial data when the page is opened
loadFinancials();
</script>
</body>
</html>